# 技术架构参考文档

## 概述

本项目采用 **MCP (Model Context Protocol) + Side Panel + WebSocket** 架构，实现 AI Agent 对浏览器的控制。

---

## 一、整体架构

```
┌────────────────────────────────────────────────────────────────────────────┐
│                    AI 客户端 (Claude Desktop / Cursor / 其他)               │
│                              MCP Client                                     │
└─────────────────────────────────────┬──────────────────────────────────────┘
                                      │ stdio (JSON-RPC 2.0)
                                      ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                           Go MCP Server                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  MCP Tools:                                                           │  │
│  │  • browser_navigate    - 页面导航                                     │  │
│  │  • browser_click       - 点击元素                                     │  │
│  │  • browser_type        - 输入文本                                     │  │
│  │  • browser_screenshot  - 截图                                         │  │
│  │  • browser_extract     - 提取内容                                     │  │
│  │  • browser_evaluate    - 执行 JS                                      │  │
│  │  • browser_scroll      - 滚动页面                                     │  │
│  │  • browser_get_tabs    - 获取标签页                                   │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                      │                                      │
│                           WebSocket Server (:3026)                          │
└──────────────────────────────────────┬─────────────────────────────────────┘
                                       │ WebSocket
                                       ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                          Chrome Extension                                   │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                         Side Panel                                    │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  WebSocket Client                                               │  │  │
│  │  │  - 连接 MCP Server                                              │  │  │
│  │  │  - 接收/转发请求                                                │  │  │
│  │  │  - 显示任务日志                                                 │  │  │
│  │  │  - 显示连接状态                                                 │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────┬──────────────────────────────────────┘  │
│                                  │ chrome.runtime.sendMessage              │
│  ┌───────────────────────────────▼──────────────────────────────────────┐  │
│  │                      Service Worker                                   │  │
│  │  ┌────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Browser Controller                                             │  │  │
│  │  │  - BrowserContext (多标签页管理)                                │  │  │
│  │  │  - Page (单页操作)                                              │  │  │
│  │  │  - ExtensionTransport (CDP 传输层)                              │  │  │
│  │  └────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────┬──────────────────────────────────────┘  │
│                                  │ chrome.debugger                         │
│  ┌───────────────────────────────▼──────────────────────────────────────┐  │
│  │                      Content Script                                   │  │
│  │  - DOM 操作辅助                                                       │  │
│  │  - 遮罩层显示                                                         │  │
│  │  - 日志收集                                                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
                              Chrome DevTools Protocol (CDP)
                                       │
                                       ▼
                                 Chrome Browser
```

---

## 二、组件说明

### 2.1 Go MCP Server

**职责：**
- 实现 MCP 协议，提供标准化的工具接口
- 通过 stdio 与 AI 客户端通信
- 通过 WebSocket 与浏览器扩展通信
- 请求转发和响应路由

**通信协议：**

| 接口 | 协议 | 说明 |
|------|------|------|
| AI 客户端 | stdio (JSON-RPC 2.0) | MCP 标准协议 |
| Chrome 扩展 | WebSocket (:3026) | 自定义消息协议 |

### 2.2 Chrome Extension - Side Panel

**职责：**
- 维持 WebSocket 连接（仅在打开时）
- 显示任务执行状态
- 转发请求到 Service Worker
- 提供用户界面

**生命周期：**

| 状态 | Side Panel | WebSocket |
|------|-----------|-----------|
| 用户打开 | 运行 | 连接 |
| 用户关闭 | 停止 | 断开 |
| 切换标签 | 保持 | 保持 |

### 2.3 Chrome Extension - Service Worker

**职责：**
- 执行浏览器控制操作
- 管理 CDP 连接
- 路由请求到对应处理器

### 2.4 Content Script

**职责：**
- 复杂 DOM 查询
- 遮罩层 UI 显示
- 控制台日志收集

---

## 三、数据流

### 3.1 完整请求流程

```
1. 用户对 Claude 说: "打开 google.com"
   │
   ▼
2. Claude 调用 MCP Tool: browser_navigate({url: "https://google.com"})
   │
   ▼
3. MCP Server 收到 JSON-RPC 请求
   │
   ▼
4. MCP Server 通过 WebSocket 发送到 Extension
   │
   ▼
5. Side Panel 收到消息，转发给 Service Worker
   │
   ▼
6. Service Worker 执行 CDP 命令
   │
   ▼
7. Chrome 执行导航
   │
   ▼
8. 结果返回: Service Worker → Side Panel → WebSocket → MCP Server → Claude
```

---

## 四、与其他方案对比

| 方案 | Native Messaging | 独立 HTTP Server | MCP + Side Panel |
|------|-----------------|------------------|------------------|
| 外部进程 | Go 程序 | Node.js/Go | Go MCP Server |
| 通信协议 | stdin/stdout | HTTP/WebSocket | MCP + WebSocket |
| 常驻页面 | 不需要 | 需要 | Side Panel |
| AI 集成 | 需要适配 | 需要适配 | 原生支持 |
| 用户界面 | 无 | 无 | 有 |

### 为什么选择 MCP + Side Panel

**优势：**

1. **AI 原生集成** - Claude Desktop / Cursor 直接支持
2. **用户体验** - Side Panel 显示任务状态
3. **架构简洁** - 无需 Offscreen Document 或常驻标签页

**限制：**

1. 需要用户手动打开 Side Panel
2. Side Panel 关闭后无法接收命令

---

## 五、端口配置

| 服务 | 端口 | 说明 |
|------|------|------|
| MCP Server WebSocket | 3026 | 扩展连接 |

---

## 六、安全考虑

1. **WebSocket** - 仅监听 127.0.0.1
2. **扩展权限** - debugger, tabs, sidePanel, activeTab, scripting
3. **MCP** - stdio 通信，无网络暴露
